name: Check Specific Ivy Version

on:
  workflow_dispatch:
    inputs:
      ivy_version:
        description: 'The specific version of Ivy to install (e.g., 1.0.0)'
        required: true
        type: string

env:
  DOTNET_VERSION: "10.0.x"
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  prepare:
    name: Prepare Projects
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.find-projects.outputs.projects }}
      project-count: ${{ steps.find-projects.outputs.project-count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Ivy version in csproj files
        run: |
          IVY_VERSION="${{ inputs.ivy_version }}"
          echo "Updating Ivy to version: $IVY_VERSION"
          
          # Find all csproj files and update the Ivy package reference
          # Using the same logic as build-all-projects.yml
          for csproj in $(find . -name "*.csproj"); do
            if grep -q 'PackageReference Include="Ivy"' "$csproj"; then
              echo "Updating: $csproj"
              sed -i \
                "s|<PackageReference Include=\"Ivy\" Version=\"[^\"]*\"|<PackageReference Include=\"Ivy\" Version=\"$IVY_VERSION\"|g" \
                "$csproj"
            fi
          done

      - name: Upload updated csproj files
        uses: actions/upload-artifact@v4
        with:
          name: updated-csproj-files
          path: |
            **/*.csproj
          retention-days: 1

      - name: Find all .NET projects
        id: find-projects
        run: |
          projects=$(find . -name "*.csproj" -not -path "*/bin/*" -not -path "*/obj/*" | sort)
          project_array="["
          first=true
          while IFS= read -r project; do
            if [ "$first" = true ]; then
              first=false
            else
              project_array="$project_array,"
            fi
            dir_name=$(dirname "$project" | xargs basename)
            project_array="$project_array{\"path\":\"$project\",\"name\":\"$dir_name\"}"
          done <<< "$projects"
          project_array="$project_array]"
          project_count=$(echo "$projects" | wc -l)
          echo "projects=$project_array" >> $GITHUB_OUTPUT
          echo "project-count=$project_count" >> $GITHUB_OUTPUT

  build:
    name: Build
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Continue building other projects even if one fails
      matrix:
        project: ${{ fromJson(needs.prepare.outputs.projects) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download updated csproj files
        uses: actions/download-artifact@v4
        with:
          name: updated-csproj-files
          path: .

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore "${{ matrix.project.path }}"

      - name: Build project
        id: build
        run: |
          echo "ðŸ”¨ Building: ${{ matrix.project.name }}"
          # Capture output to a file to extract errors later if needed
          if ! dotnet build "${{ matrix.project.path }}" --configuration Release --no-restore --verbosity normal > build.log 2>&1; then
            echo "::error::Build failed for ${{ matrix.project.name }}"
            cat build.log
            echo "failure" > status.txt
          else
            echo "success" > status.txt
          fi

      - name: Process compilation errors
        if: always()
        run: |
          # Create a safe name for the artifact
          SAFE_NAME=$(echo "${{ matrix.project.path }}" | sed 's/[\/\.]/-/g')
          
          if [ "$(cat status.txt)" == "failure" ]; then
            echo "Extracting errors..."
            # Simple grep for errors - can be improved to match MSBuild error format
            grep -E ": error" build.log > "${SAFE_NAME}_errors.txt" || echo "Unknown error check build logs" > "${SAFE_NAME}_errors.txt"
          fi
          
          echo "SAFE_NAME=$SAFE_NAME" >> $GITHUB_ENV

      - name: Upload Error Log
        if: always() && hashFiles('*_errors.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: error-log-${{ env.SAFE_NAME }}
          path: ${{ env.SAFE_NAME }}_errors.txt
          retention-days: 1

  report:
    name: Compilation Report
    needs: [prepare, build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all error logs
        uses: actions/download-artifact@v4
        with:
          pattern: error-log-*
          path: error-logs
          merge-multiple: true

      - name: Generate Summary
        id: summary
        run: |
          echo "# ðŸ“‹ Compilation Error Report for Ivy Version ${{ inputs.ivy_version }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$(ls -A error-logs 2>/dev/null)" ]; then
            echo "âœ… **Success!** No compilation errors found in any project." >> $GITHUB_STEP_SUMMARY
            echo "has_errors=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ **Fail!** The following projects have compilation errors:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "has_errors=true" >> $GITHUB_OUTPUT
            
            for f in error-logs/*; do
              # Clean up filename to get project identifier roughly
              filename=$(basename "$f")
              project_id=$(echo "$filename" | sed 's/_errors.txt//')
              
              echo "### ðŸ”´ Project: $project_id" >> $GITHUB_STEP_SUMMARY
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>View Errors</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat "$f" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: Fail workflow if errors exist
        if: steps.summary.outputs.has_errors == 'true'
        run: |
          echo "Compilation errors detected."
          exit 1
